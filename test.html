<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Request Example</title>
</head>

<body>
    <button id="fetch-button">Fetch Data</button>
    <div id="data-container"></div>

    <script>
        const port = 7148; // Replace with your actual port number
        const port2 = 5236; // Replace with your actual port number
        const url = `http://localhost:${port2}/api/getanusuchis`;
        const fetchButton = document.getElementById('fetch-button');
        const dataContainer = document.getElementById('data-container');

        fetchButton.addEventListener('click', () => {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(res => {
                    console.log(res);
                    showAnusuchiDetails(res.data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    dataContainer.innerText = `Error: ${error.message}`;
                });
        });

        function showAnusuchiDetails(anusuchis) {
            anusuchis.forEach(anusuchi => {
                const div = document.createElement('div');

                // Add Anusuchi Name:
                const anusuchiNumberElement = document.createElement('p');
                anusuchiNumberElement.textContent = `Anusuchi ${anusuchi.id}`;
                div.appendChild(anusuchiNumberElement);

                // Add Anusuchi Name:
                const anusuchiNameElement = document.createElement('p');
                anusuchiNameElement.textContent = anusuchi.anusuchiName;
                div.appendChild(anusuchiNameElement);

                // Add Anusuchi Name:
                const anusuchiRelatedDafaElement = document.createElement('p');
                anusuchiRelatedDafaElement.textContent = anusuchi.relatedToDafaNo;;
                div.appendChild(anusuchiRelatedDafaElement);

                if (anusuchi.parichheds?.length > 0) {
                    anusuchi.parichheds.forEach(parichhed => div.appendChild(showParichhedDetails(parichhed)));
                }

                if (anusuchi.subAnusuchis?.length > 0) {
                    anusuchi.subAnusuchis.forEach(subAnusuchi => div.appendChild(showAnusuchiDetails(subAnusuchi)));
                }

                if (anusuchi.mapdandas?.length > 0) {
                    div.appendChild(createMapdandaTable(anusuchi));
                }

                dataContainer.appendChild(div);
            });
        }

        function showParichhedDetails(parichhed) {
            const div = document.createElement('div');
            // Add Parichhed Number:
            const parichhedNumberElement = document.createElement('p');
            parichhedNumberElement.textContent = `parichhed ${parichhed.id}`;
            div.appendChild(parichhedNumberElement);

            // Add parichhed Name:
            const parichhedNameElement = document.createElement('p');
            parichhedNameElement.textContent = parichhed.parichhedName;
            div.appendChild(parichhedNameElement);

            if (parichhed.mapdandas?.length > 0) {
                div.appendChild(createMapdandaTable(parichhed));
            }

            if (parichhed.subParichheds?.length > 0) {
                div.appendChild(parichhed.subParichheds.forEach(subParichhed => showParichhedData(subParichhed)));
            }
            return div;
        }

        function createMapdandaTable(obj) {
            const div = document.createElement('div');
            const table = document.createElement('table');
            table.border = '1px solid black';
            table.cellSpacing = '0';

            // Create table headers:
            const tableHeader = createTableHeaders(obj);
            table.appendChild(tableHeader);

            table.appendChild(createMapdandaTableRow(obj));
            div.appendChild(table);
            return div;
        }

        function createTableHeaders(obj) {
            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            const tr1 = document.createElement('tr');
            obj.tableHeaders.forEach((header, index) => {
                const th = document.createElement('th');
                th.rowSpan = 2; // hard coded for now
                th.textContent = header.cellName;
                if (header.subCells && header.subCells.length > 0) {
                    th.rowSpan = 1; // hard coded for now
                    th.textContent = header.cellName;
                    th.colSpan = header.subCells.length;
                    tr1.append(...attachTableSubHeaders(header.subCells));
                }
                tr.appendChild(th);
            });
            thead.appendChild(tr);
            if (tr1.children.length > 0) thead.appendChild(tr1);
            return thead;
        }

        function attachTableSubHeaders(obj) {
            const ths = [];
            obj.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.cellName;
                console.log(header.cellName)
                ths.push(th);
                if (header.subCells && header.subCells.length > 0) {
                    ths.push(...attachTableSubHeaders(header.subCells));
                }
            });
            console.log(ths);
            return ths;
        }

        function attachSubHeaderRows(obj) {
            const ths = [];
            obj.forEach(header => {
                const th = document.createElement('th');
                ths.push(th);
                if (header.subCells && header.subCells.length > 0) {
                    ths.push(attachTableSubHeaders(header.subCells));
                }

            });
            return ths;
        }

        function createMapdandaTableRow(obj) {
            const tbody = document.createElement('tbody');
            obj.mapdandas.forEach(mapdanda => {
                const tr = document.createElement('tr');
                obj.tableHeaders.forEach(header => {
                    const td = document.createElement('td');
                    if (header.subCells && header.subCells.length > 0) {
                        tr.append(...attachSubHeaderRows(header.subCells));
                    } else {
                        tr.appendChild(td);
                    }
                });

                let mapdandaKeys = Object.keys(mapdanda);
                let mapdandaIndex = 0;

                obj?.tableHeaders.forEach((header, headerIndex) => {
                    const td = tr.children[headerIndex];

                    while (
                        mapdandaKeys[mapdandaIndex] === 'id' ||
                        mapdandaKeys[mapdandaIndex] === 'anusuchiId' ||
                        mapdandaKeys[mapdandaIndex] === 'parichhedId' ||
                        mapdandaKeys[mapdandaIndex] === 'isAvailableDivided' ||
                        mapdandaKeys[mapdandaIndex] === 'anusuchi' ||
                        mapdandaKeys[mapdandaIndex] === 'parichhed' ||
                        mapdandaKeys[mapdandaIndex] === 'subParichhedId' ||
                        mapdandaKeys[mapdandaIndex] === 'subParichhed' ||
                        mapdandaKeys[mapdandaIndex] === 'subMapdandas' ||
                        mapdandaKeys[mapdandaIndex] === 'relatedToDafaNo'
                    ) {
                        mapdandaIndex++;
                    }

                    const mapdandaKey = mapdandaKeys[mapdandaIndex];

                    if (mapdandaKey && mapdanda.hasOwnProperty(mapdandaKey)) {
                        td.textContent = mapdanda[mapdandaKey];
                    } else {
                        td.textContent = "";
                    }
                    mapdandaIndex++;
                });
                tbody.appendChild(tr);
            });
            return tbody;
        }

    </script>
</body>

</html>